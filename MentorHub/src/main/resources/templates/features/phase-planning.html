<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="fragments/head"></th:block>
    <title>MentorHub :: Phase Planning</title>
</head>

<body>
<th:block th:replace="fragments/header"></th:block>


<!-- Modal -->
<div aria-hidden="true" aria-labelledby="exampleModalLabel" class="modal fade" id="exampleModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Edit Phase</h5>
                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">

                <label class="w-100 mb-3" for="phasename">Phase name: <br>
                    <input class="form-control mt-1" id="phasename" placeholder="Enter a name" type="text">
                </label>
                <br>
                <label class="w-100" for="phasedate">End date: <br>
                    <input class="form-control mt-1" id="phasedate" placeholder="Enter a date" type="date">
                </label>

            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Close</button>
                <button class="btn btn-primary" th:onclick="saveChanges()" type="button">Save
                    changes
                </button>
            </div>
        </div>
    </div>
</div>

<div style="min-height: 100vh;">
    <div class="container pt-5">
        <div class="card">
            <div class="card-header">
                <a class="btn btn-secondary rounded-circle" th:href="@{/details/{id}(id=${mentorship.id})}"><i
                        class="fas fa-arrow-left"></i></a>
            </div>
            <div class="card-body">
                <h4 class="my-4">Phase planning</h4>
                <div class="container">
                    <p th:if="${mentorship.phases.isEmpty()}">No phase added.</p>
                    <ol class="list-group list-group-numbered" id="phaseList">

                        <li class="list-group-item" th:each="phase, iter : ${mentorship.phases}" th:id="${phase.id}"
                            th:data-sort="${#dates.format(phase.endDate, 'yyyy-MM-dd')}">
                            <div class="row">
                                <div class="col">
                                    <th:block th:text="${phase.name}"></th:block>
                                    <br>
                                    <small class="text-muted">
                                        End date: <span
                                            th:text="${#dates.format(phase.endDate, 'yyyy-MM-dd')}"></span>
                                    </small>
                                </div>
                                <div class="col-auto btn-group mt-3">
                                    <button class="btn btn-primary"
                                            th:onclick="editPhase([[${phase.name}]], [[${#dates.format(phase.endDate, 'yyyy-MM-dd')}]], [[${phase.id}]])"
                                            type="button">
                                        Edit
                                    </button>
                                    <button class="btn btn-danger" th:onclick="removePhase([[${phase.id}]])"
                                            type="button">
                                        Remove
                                    </button>
                                </div>
                            </div>
                        </li>

                    </ol>
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-secondary" onclick="addPhase()" type="button">Add</button>
            </div>
        </div>
    </div>
</div>

<th:block th:replace="fragments/footer"></th:block>


<script th:inline="javascript">
    const myModal = new bootstrap.Modal($("#exampleModal"))
    const mentorshipId = /*[[${mentorship.id}]]*/ "";
    let selectedPhaseId = null;

    let editPhase = function (phaseName, phaseDate, phaseId) {
        selectedPhaseId = phaseId;
        $("#phasename").val(phaseName);
        $("#phasedate").val(phaseDate);
        myModal.show();
    }

    let addPhase = function () {
        selectedPhaseId = null;
        $("#phasename").val("");
        $("#phasedate").val("");
        myModal.show();
    }

    let removePhase = function (phaseId) {
        $.ajax({
            type: 'DELETE',
            url: `http://localhost:8080/api/mentorships/${mentorshipId}/phases/${phaseId}`,
            success: function (deletedId, status, xhr) {
                $(`#${deletedId}`).remove();
                showToast("bg-success", "Sucessfully removed!");
            },
            error: function (jqXhr, textStatus, errorMessage) {
                if (!jqXhr.responseText)
                    errorMessage = "Something went wrong!";
                else
                    errorMessage = jqXhr.responseText;
                showToast("bg-danger", errorMessage);
            }
        });
    }

    let saveChanges = function () {
        data = {
            "id": selectedPhaseId,
            "name": $('#phasename').val(),
            "endDate": $('#phasedate').val(),
            "status": "unbegun"
        };
        $.ajax({
            type: 'PUT',
            url: `http://localhost:8080/api/mentorships/${mentorshipId}/phases`,
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (createdId, status, xhr) {
                let DOMelement = `
                <li class="list-group-item" id="${createdId}" data-sort="${data.endDate}">
                    <div class="row">
                        <div class="col">
                            ${data.name}
                            <br>
                            <small class="text-muted">
                                End date: <span>${data.endDate}</span>
                            </small>
                        </div>
                        <div class="col-auto btn-group mt-3">
                            <button class="btn btn-primary" onclick="editPhase('${data.name}', '${data.endDate}', '${createdId}')" type="button">
                                Edit
                            </button>
                            <button class="btn btn-danger" onclick="removePhase('${createdId}')" type="button">
                                Remove
                            </button>
                        </div>
                    </div>
                </li>`;
                $(`#${createdId}`).remove();
                $("#phaseList").append(DOMelement);
                sortedList = $("#phaseList").children().sort(function (a, b) {
                    return new Date($(a).data("sort")) - new Date($(b).data("sort"));
                });
                $("#phaseList").html(sortedList);
                myModal.hide();
                showToast("bg-success", "Changes saved!");
            },
            error: function (jqXhr, textStatus, errorMessage) {
                if (!jqXhr.responseText)
                    errorMessage = "Something went wrong!";
                else
                    errorMessage = jqXhr.responseText;
                showToast("bg-danger", errorMessage);
            }
        });
    }

</script>

</body>
</html>

